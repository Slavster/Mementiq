<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frame.io OAuth Authorization</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px; 
            line-height: 1.6;
        }
        .header { background: #2563eb; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .step { background: #f8fafc; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #2563eb; }
        .success { background: #dcfce7; border-left-color: #16a34a; }
        .warning { background: #fef3c7; border-left-color: #d97706; }
        .auth-button { 
            display: inline-block;
            background: #16a34a; 
            color: white; 
            padding: 15px 30px; 
            text-decoration: none; 
            border-radius: 8px; 
            font-weight: 600;
            margin: 10px 0;
        }
        .auth-button:hover { background: #15803d; }
        .token-input { 
            width: 100%; 
            padding: 10px; 
            border: 2px solid #d1d5db; 
            border-radius: 6px; 
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Frame.io OAuth Authorization Required</h1>
        <p>Complete OAuth setup to enable real project creation with full API access</p>
    </div>

    <div class="step warning">
        <h3>Current Status</h3>
        <p>The old developer token has been unlinked. OAuth authorization is now required to create real Frame.io projects and manage assets at the account level.</p>
    </div>

    <div class="step">
        <h3>Step 1: Generate OAuth URL</h3>
        <button onclick="generateAuthUrl()" style="background: #2563eb; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">
            Generate Authorization URL
        </button>
        <div id="authResult"></div>
    </div>

    <div class="step">
        <h3>Step 2: Update Token in Secrets</h3>
        <p>After completing authorization, copy your new access token here:</p>
        <textarea id="tokenInput" class="token-input" rows="3" placeholder="Paste your new Frame.io access token here..."></textarea>
        <br><br>
        <button onclick="updateToken()" style="background: #16a34a; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">
            Test New Token
        </button>
        <div id="tokenResult"></div>
    </div>

    <div class="step">
        <h3>Step 3: Verify Project Creation</h3>
        <button onclick="testProjectCreation()" style="background: #7c3aed; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">
            Test Project Creation
        </button>
        <div id="projectResult"></div>
    </div>

    <script>
        async function generateAuthUrl() {
            const resultDiv = document.getElementById('authResult');
            resultDiv.innerHTML = '<p>Generating OAuth URL...</p>';
            
            try {
                const response = await fetch('/api/frameio/oauth/url');
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div style="background: #dcfce7; padding: 15px; border-radius: 6px; margin-top: 15px;">
                            <h4 style="color: #16a34a; margin: 0 0 10px 0;">Authorization URL Generated</h4>
                            <a href="${data.authUrl}" target="_blank" class="auth-button">
                                Authorize Frame.io Access
                            </a>
                            <p style="font-size: 14px; color: #374141; margin-top: 15px;">
                                <strong>Required Scopes:</strong> account.read, asset.create, asset.read, project.create, project.read, offline
                            </p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div style="background: #fecaca; padding: 15px; border-radius: 6px; margin-top: 15px; color: #dc2626;">${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="background: #fecaca; padding: 15px; border-radius: 6px; margin-top: 15px; color: #dc2626;">Network error: ${error.message}</div>`;
            }
        }

        async function updateToken() {
            const token = document.getElementById('tokenInput').value.trim();
            const resultDiv = document.getElementById('tokenResult');
            
            if (!token) {
                resultDiv.innerHTML = '<div style="background: #fecaca; padding: 15px; border-radius: 6px; margin-top: 15px; color: #dc2626;">Please enter a token first</div>';
                return;
            }
            
            resultDiv.innerHTML = '<p>Testing new token...</p>';
            
            try {
                const response = await fetch('https://api.frame.io/v2/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    resultDiv.innerHTML = `
                        <div style="background: #dcfce7; padding: 15px; border-radius: 6px; margin-top: 15px;">
                            <h4 style="color: #16a34a; margin: 0 0 10px 0;">Token Valid!</h4>
                            <p><strong>User:</strong> ${userData.name} (${userData.email})</p>
                            <p><strong>Account ID:</strong> ${userData.account_id}</p>
                            <p style="font-size: 14px; color: #374141; margin-top: 10px;">
                                Now update FRAMEIO_API_TOKEN in Replit Secrets with this token and restart the application.
                            </p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div style="background: #fecaca; padding: 15px; border-radius: 6px; margin-top: 15px; color: #dc2626;">Invalid token (${response.status})</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="background: #fecaca; padding: 15px; border-radius: 6px; margin-top: 15px; color: #dc2626;">Error testing token: ${error.message}</div>`;
            }
        }

        async function testProjectCreation() {
            const resultDiv = document.getElementById('projectResult');
            resultDiv.innerHTML = '<p>Testing project creation capabilities...</p>';
            
            try {
                const response = await fetch('/api/test-frameio-photo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: 'project_creation' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div style="background: #dcfce7; padding: 15px; border-radius: 6px; margin-top: 15px;">
                            <h4 style="color: #16a34a; margin: 0 0 10px 0;">Project Creation Working!</h4>
                            <p>Frame.io integration is fully operational with OAuth credentials.</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div style="background: #fecaca; padding: 15px; border-radius: 6px; margin-top: 15px;">
                            <h4 style="color: #dc2626; margin: 0 0 10px 0;">Project Creation Failed</h4>
                            <p>${data.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="background: #fecaca; padding: 15px; border-radius: 6px; margin-top: 15px; color: #dc2626;">Test failed: ${error.message}</div>`;
            }
        }

        // Auto-generate URL on page load
        window.onload = function() {
            generateAuthUrl();
        };
    </script>
</body>
</html>